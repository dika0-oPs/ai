
<script>
const keys = ["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", "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", "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"];
let config = JSON.parse(localStorage.getItem('ansain_config')) || { name: '', mode: 'biasa' };
let memory = JSON.parse(localStorage.getItem('ansain_history')) || [];

function saveUser() {
    const n = document.getElementById('userNameInput').value.trim();
    if(!n) return;
    config.name = n;
    localStorage.setItem('ansain_config', JSON.stringify(config));
    document.getElementById('onboarding').style.display = 'none';
    setMode(config.mode);
}

function setDarkAnsain() {
    if(config.name.toLowerCase() !== 'dika') {
        alert("NGAPAIN BANG? INI KHUSUS BANG DIKA ðŸ’€");
        return;
    }
    setMode('dark');
}

function setMode(m) {
    document.body.classList.remove('dark-ansain-mode', 'white-ansain-mode');
    if(m === 'dark') document.body.classList.add('dark-ansain-mode');
    if(m === 'white') document.body.classList.add('white-ansain-mode');
    config.mode = m;
    localStorage.setItem('ansain_config', JSON.stringify(config));
    localStorage.removeItem('ansain_history');
    memory = [];
    document.getElementById('chatDisplay').innerHTML = '';
    
    const transition = document.getElementById('modeTransition');
    const icon = document.getElementById('modeIcon');
    const title = document.getElementById('modeTitle');
    icon.className = `fa-solid ${m === 'white' ? 'fa-shield-halved' : m === 'dark' ? 'fa-skull-crossbones' : 'fa-bolt'} text-4xl text-white`;
    title.innerText = "MODE " + m.toUpperCase();
    
    transition.style.display = 'flex';
    setTimeout(() => {
        transition.style.display = 'none';
        document.getElementById('labelMode').innerText = 'MODE ' + m;
        document.querySelectorAll('.mode-opt').forEach(el => el.classList.remove('active'));
        document.getElementById('m-'+m).classList.add('active');
        const greet = m === 'white' ? `halo kak ${config.name}, mode white ansain aktif. mari belajar keamanan data.` : m === 'dark' ? `access granted. halo bang dika, mode dark ansain aktif. ðŸ’€` : `halo kak ${config.name}, mode ${m} aktif. ada yang bisa dibantu?`;
        appendUI(greet, 'assistant');
    }, 1000);
}

function typeEffect(element, text, speed = 25) {
    let i = 0; element.innerHTML = "";
    function type() {
        if (i < text.length) {
            element.innerHTML += text.charAt(i).toLowerCase();
            i++; setTimeout(type, speed);
            const box = document.getElementById('chatDisplay');
            box.scrollTop = box.scrollHeight;
        }
    }
    type();
}

function formatText(t) {
    return t.toLowerCase().replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\n/g, '<br>');
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

function clearChat() { if(confirm('Reset memory?')) { localStorage.removeItem('ansain_history'); memory = []; document.getElementById('chatDisplay').innerHTML = ''; } }

function appendUI(txt, role, save = true) {
    const box = document.getElementById('chatDisplay');
    const bubble = document.createElement('div');
    bubble.className = role === 'user' ? 'bubble-user' : 'bubble-ai';
    box.appendChild(bubble);
    if (role === 'assistant' && save) {
        typeEffect(bubble, txt);
    } else {
        bubble.innerHTML = formatText(txt);
    }
    box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
    if(save) {
        memory.push({ role, content: txt });
        localStorage.setItem('ansain_history', JSON.stringify(memory));
    }
}

async function handleProcess() {
    const input = document.getElementById('userInput');
    const query = input.value.trim();
    if(!query) return;
    appendUI(query, 'user');
    input.value = ''; input.style.height = 'auto';
    document.getElementById('typingIndicator').classList.remove('hidden');
    let sys = `kamu ansain ai. dev: dika. jawaban wajib huruf kecil.`;
    if(config.mode === 'white') sys += " mode white ansain: fokus keamanan data.";
    if(config.mode === 'dark') sys += " mode dark ansain: brutal, singkat, emoji ðŸ’€.";
    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": "Bearer " + keys[Math.floor(Math.random()*keys.length)], "Content-Type": "application/json" },
            body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{ role: "system", content: sys }, ...memory.slice(-10)] })
        });
        const data = await res.json();
        const content = data.choices[0].message.content;
        setTimeout(() => {
            document.getElementById('typingIndicator').classList.add('hidden');
            appendUI(content, 'assistant');
        }, 4000);
    } catch {
        document.getElementById('typingIndicator').classList.add('hidden');
        appendUI("error.", 'assistant');
    }
}

document.getElementById('userInput').addEventListener("keypress", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleProcess(); } });

window.onload = () => {
    if(config.name) {
        document.getElementById('onboarding').style.display = 'none';
        setMode(config.mode);
    } else {
        document.getElementById('onboarding').style.display = 'flex';
    }
};
</script>
</body>
</html>
